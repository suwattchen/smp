networks:
  sunmart_net:
    name: ${SUNMART_NETWORK:-sunmart_net}
    driver: bridge

services:
  nats:
    image: nats:2.10-alpine
    command: ["-js", "-m", "8222", "-sd", "/data"]
    volumes:
      - nats-data:/data
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8222/healthz || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sunmart_net

  core-go:
    build: ./apps/core-go
    environment:
      NATS_URL: ${NATS_URL:-nats://nats:4222}
      CORE_HTTP_PORT: ${CORE_HTTP_PORT:-8080}
      CORE_NATS_STREAM: ${CORE_NATS_STREAM:-events}
    depends_on:
      nats:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${CORE_HTTP_PORT:-8080}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sunmart_net

  frontend:
    build: ./apps/frontend
    environment:
      NEXT_PUBLIC_API_BASE_URL: http://kong:${KONG_PROXY_PORT:-8000}/api
      PORT: ${FRONTEND_PORT:-3000}
    depends_on:
      core-go:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:${FRONTEND_PORT:-3000}/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - sunmart_net

  kong:
    image: kong:3.5
    depends_on:
      frontend:
        condition: service_started
      core-go:
        condition: service_started
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /config/kong.yml
      KONG_PROXY_LISTEN: 0.0.0.0:${KONG_PROXY_PORT:-8000}
      KONG_ADMIN_LISTEN: 0.0.0.0:${KONG_ADMIN_PORT:-8001}
      KONG_STATUS_LISTEN: 0.0.0.0:8100
      KONG_LOG_LEVEL: notice
      KONG_ADMIN_GUI_ACCESS_LOG: /dev/stdout
      KONG_ADMIN_GUI_ERROR_LOG: /dev/stderr
    volumes:
      - ./infra/kong/kong.yml:/config/kong.yml:ro
    ports:
      - "${KONG_PROXY_PORT:-8000}:${KONG_PROXY_PORT:-8000}"
      - "${KONG_ADMIN_PORT:-8001}:${KONG_ADMIN_PORT:-8001}"
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 10s
      retries: 5
    networks:
      - sunmart_net

volumes:
  nats-data:
